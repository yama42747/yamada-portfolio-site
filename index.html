<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Locked</title>
  <style>
    :root { color-scheme: light; }
    html, body { height: 100%; margin: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
      background: #59ffa1;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .lock {
      width: min(520px, calc(100% - 32px));
      background: rgba(255,255,255,0.65);
      border: 2px solid #000;
      border-radius: 22px;
      padding: 18px 16px;
      box-shadow: 0 18px 35px rgba(0,0,0,0.12);
    }
    .title { font-weight: 800; letter-spacing: 0.02em; margin: 0 0 10px; }
    .desc { margin: 0 0 14px; font-size: 14px; line-height: 1.5; }
    .row { display: flex; gap: 10px; }
    input[type="password"]{
      flex: 1;
      height: 44px;
      border-radius: 14px;
      border: 2px solid #000;
      padding: 0 12px;
      font-size: 16px;
      background: #fff;
      outline: none;
    }
    button{
      height: 44px;
      padding: 0 14px;
      border-radius: 14px;
      border: 2px solid #000;
      background: #fff;
      font-weight: 700;
      cursor: pointer;
    }
    .msg { margin-top: 10px; min-height: 20px; font-size: 14px; }
    .msg.err { color: #b00020; font-weight: 700; }
    .msg.ok { color: #0b3d2e; font-weight: 700; }
    .hint { margin-top: 10px; font-size: 12px; opacity: 0.75; }
    .app {
      position: fixed;
      inset: 0;
      display: none;
      background: #59ffa1;
    }
    iframe{
      width: 100%;
      height: 100%;
      border: 0;
      display: block;
      background: transparent;
    }
  </style>
</head>
<body>
  <div class="lock" id="lockBox">
    <h1 class="title">Enter Passcode</h1>
    <p class="desc">This portfolio is protected. Please enter the passcode to view.</p>
    <div class="row">
      <input id="pass" type="password" autocomplete="current-password" inputmode="text" placeholder="Passcode" />
      <button id="unlock">Unlock</button>
    </div>
    <div class="msg" id="msg"></div>
    <div class="hint">Tip: you can bookmark specific pages like <b>#works</b> after unlocking.</div>
  </div>

  <div class="app" id="app">
    <iframe id="frame" referrerpolicy="no-referrer"></iframe>
  </div>

<script>
/**
 * content.enc.json format:
 * { v, kdf:"PBKDF2-SHA256", iter, salt(base64), iv(base64), ct(base64) }
 * plaintext:
 * { pages: { home, about, works, contact } }  // each is full HTML string
 */

let PAGES = null;

const $ = (id) => document.getElementById(id);
const passEl = $('pass');
const msgEl  = $('msg');
const appEl  = $('app');
const lockEl = $('lockBox');
const frame  = $('frame');

function b64ToBytes(b64){
  const bin = atob(b64);
  const bytes = new Uint8Array(bin.length);
  for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
  return bytes;
}
async function deriveKey(pass, saltBytes, iterations){
  const enc = new TextEncoder();
  const baseKey = await crypto.subtle.importKey(
    'raw',
    enc.encode(pass),
    { name: 'PBKDF2' },
    false,
    ['deriveKey']
  );
  return crypto.subtle.deriveKey(
    {
      name: 'PBKDF2',
      salt: saltBytes,
      iterations: iterations,
      hash: 'SHA-256'
    },
    baseKey,
    { name: 'AES-GCM', length: 256 },
    false,
    ['decrypt']
  );
}

function injectBridge(html){
  const bridge = `
<script>
(() => {
  function routeFromHref(href){
    if (!href) return null;
    const h = href.split('#')[0].split('?')[0];
    if (h.endsWith('index.html') || h === '' || h === './') return 'home';
    if (h.endsWith('about.html')) return 'about';
    if (h.endsWith('works.html')) return 'works';
    if (h.endsWith('contact.html')) return 'contact';
    return null;
  }
  document.addEventListener('click', (e) => {
    const a = e.target.closest && e.target.closest('a');
    if (!a) return;
    const href = a.getAttribute('href') || '';
    if (/^(https?:)?\/\//i.test(href) || /^mailto:/i.test(href) || /^tel:/i.test(href)) return;
    const r = routeFromHref(href);
    if (!r) return;
    e.preventDefault();
    window.parent && window.parent.postMessage({ type: 'route', route: r }, '*');
  }, { capture: true });
})();
<\/script>`;
  if (html.includes('</body>')) return html.replace('</body>', bridge + '\n</body>');
  return html + bridge;
}

function getRoute(){
  const h = (location.hash || '').replace('#','').trim().toLowerCase();
  if (h === 'about' || h === 'works' || h === 'contact' || h === 'home') return h;
  return 'home';
}

function render(route){
  if (!PAGES) return;
  const html = PAGES[route] || PAGES.home;
  frame.srcdoc = injectBridge(html);
  location.hash = '#' + route;
}

async function unlock(){
  msgEl.className = 'msg';
  msgEl.textContent = 'Loading...';
  const pass = passEl.value || '';
  try{
    const res = await fetch('content.enc.json', { cache: 'no-store' });
    if (!res.ok) throw new Error('Failed to fetch content.enc.json');
    const enc = await res.json();

    const salt = b64ToBytes(enc.salt);
    const iv   = b64ToBytes(enc.iv);
    const ct   = b64ToBytes(enc.ct);

    const key = await deriveKey(pass, salt, enc.iter || 200000);
    const ptBuf = await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, key, ct);
    const ptText = new TextDecoder().decode(ptBuf);
    const bundle = JSON.parse(ptText);

    if (!bundle || !bundle.pages) throw new Error('Invalid decrypted data');
    PAGES = bundle.pages;

    // show app
    lockEl.style.display = 'none';
    appEl.style.display = 'block';

    msgEl.className = 'msg ok';
    msgEl.textContent = 'Unlocked';

    render(getRoute());
  }catch(err){
    msgEl.className = 'msg err';
    msgEl.textContent = 'Passcode is incorrect (or content is unavailable).';
    console.warn(err);
  }
}

$('unlock').addEventListener('click', unlock);
passEl.addEventListener('keydown', (e) => {
  if (e.key === 'Enter') unlock();
});

window.addEventListener('message', (e) => {
  if (!e.data || e.data.type !== 'route') return;
  render(e.data.route);
});

window.addEventListener('hashchange', () => {
  if (PAGES) render(getRoute());
});
</script>
</body>
</html>
